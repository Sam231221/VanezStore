<script>
	$(document).ready(function () {

		let deleteBtns = document.getElementsByClassName('product-delete-btn')
		for (let i = 0; i < deleteBtns.length; i++) {
			deleteBtns[i].addEventListener('click', function () {
				console.log('sdfsdfsdf')
			})
		}
		$('.product-delete-btn').on('click', function () {
			output = " ";
			console.log('fine')
			const getToken = (name) => {
				var cookieValue = null;
				if (document.cookie && document.cookie !== '') {
					var cookies = document.cookie.split(';');
					for (var i = 0; i < cookies.length; i++) {
						var cookie = cookies[i].trim();
						if (cookie.substring(0, name.length + 1) === (name + '=')) {
							cookieValue = decodeURIComponent(cookie.substring(
								name.length += 1));
							break;
						}
					}
				}
				return cookieValue;
			}
			let csrftoken = getToken('csrftoken');

			let fdata = {
				"prod_id": $(this).attr('prod-id'),
				'csrfmiddlewaretoken': csrftoken
			}
			mythis = this;
			console.log(fdata)
			$.ajax({
				url: "{% url 'Basket:basket-delete-view' %}",
				method: "post",
				data: fdata,
				dataType: 'json',
				success: function (response) {
					console.log(response)
					if (response.action == 'delete') {
						//Remove Element
						const cartDiv = document.getElementById("your-cart")
						cartDiv.setAttribute('data-notify', response.basketqty)
						$(mythis).closest('tr').fadeOut()

						//updating value in Elements
						document.getElementById('header-cart-total').innerHTML = "Total: $" + response.basket_subtotal_price
						document.getElementById('cart-' + response.delete_id).style.display = "none";
						document.getElementById("basket-stotal-price").innerHTML = '$' + response.basket_subtotal_price
					}
				},
				error: function (error) {
					console.log(error)
				}
			})

		})


		//loadmore
		$("#loadMore").on('click', function () {
			var _currentProducts = $(".product-box").length;
			var _limit = $(this).attr('data-limit');
			var _total = $(this).attr('data-total');

			$.ajax({
				url: "/load_more_view/",
				data: {
					limit: _limit,
					offset: _currentProducts
				},
				dataType: 'json',
				beforeSend: function () {
					//user can't click the button by the time
					$("#loading").attr('disabled', true);
					$(".load-more-icon").addClass('fa-spin');
				},
				success: function (res) {
					console.log(res)
					$("#filteredProducts").append(res.products);
					$("#loadMore").attr('disabled', false);
					$(".load-more-icon").removeClass('fa-spin');

					var _totalShowing = $(".product-box").length;
					if (_totalShowing == _total) {
						$("#loadMore").remove();
					}
				}
			});
			// End
		});


		// Product Variation
		$(".choose-size").hide();

		// Show size according to selected color
		$(".choose-color").on('click', function () {
			$(".choose-size").removeClass('active');
			$(".choose-color").removeClass('focused');
			$(this).addClass('focused');

			var _color = $(this).attr('data-color');

			$(".choose-size").hide();
			$(".color" + _color).show();
			$(".color" + _color).first().addClass('active');

			var _price = $(".color" + _color).first().attr('data-price');
			$(".product-price").text(_price);

		});
		// End

		// Show the price according to selected size
		$(".choose-size").on('click', function () {
			$(".choose-size").removeClass('active');
			$(this).addClass('active');

			var _price = $(this).attr('data-price');
			$(".product-price").text(_price);
		})
		// End

		// Show the first selected color
		$(".choose-color").first().addClass('focused');
		var _color = $(".choose-color").first().attr('data-color');
		var _price = $(".choose-size").first().attr('data-price');

		$(".color" + _color).show();
		$(".color" + _color).first().addClass('active');
		$(".product-price").text(_price);

		// Add to cart
		$(document).on('click', ".add-to-cart", function () {
			var _vm = $(this);
			var _index = _vm.attr('data-index');
			var _qty = $(".product-qty-" + _index).val();
			var _productId = $(".product-id-" + _index).val();
			var _productImage = $(".product-image-" + _index).val();
			var _productTitle = $(".product-title-" + _index).val();
			var _productPrice = $(".product-price-" + _index).text();
			// Ajax
			$.ajax({
				url: '/add-to-cart',
				data: {
					'id': _productId,
					'image': _productImage,
					'qty': _qty,
					'title': _productTitle,
					'price': _productPrice
				},
				dataType: 'json',
				beforeSend: function () {
					_vm.attr('disabled', true);
				},
				success: function (res) {
					$(".cart-list").text(res.totalitems);
					_vm.attr('disabled', false);
				}
			});
			// End
		});
		// End

		// Delete item from cart
		$(document).on('click', '.delete-item', function () {
			var _pId = $(this).attr('data-item');
			var _vm = $(this);
			// Ajax
			$.ajax({
				url: '/delete-from-cart',
				data: {
					'id': _pId,
				},
				dataType: 'json',
				beforeSend: function () {
					_vm.attr('disabled', true);
				},
				success: function (res) {
					$(".cart-list").text(res.totalitems);
					_vm.attr('disabled', false);
					$("#cartList").html(res.data);
				}
			});
			// End
		});

		// Update item from cart
		$(document).on('change', '.selectQuantity', function () {
			console.log('ss')
			let prod_qty = $(this).val();
			let prod_id = $(this).attr('pdt_id')
			let prod_name = $(this).attr('pdt_name')
			console.log(prod_qty, prod_id, prod_name)
			var _vm = $(this);
			// Ajax
			$.ajax({
				type: "POST",
				url: "{% url 'Basket:basket-update-view' %}",
				data: {
					'prod_id': prod_id,
					'prod_name': prod_name,
					'prod_qty': prod_qty,
					'csrfmiddlewaretoken': csrftoken,
				},

				dataType: 'json',
				beforeSend: function () {
					_vm.attr('disabled', true);
				},
				success: function (res) {
					console.log(res)
					$("#basket-stotal-price").html('Rs ' + res.basketsubtotal);


					//update table
					const tableCart = document.getElementById('table-shopping-cart')
					let outputhtml = ''
					let products = res.products
					products.forEach((product) => {
						outputhtml += `
						  
							<tr class="p-3">
								<td class="column-1">
									<div class="how-itemcart1">
										<img src="${product['thumbnail']}" alt="IMG">
									</div>
								</td>
								<td class="column-2"> ${product['title']}</td>
								<td class="column-3">Rs ${product['price']}</td>
								<td class="column-4" style="width: 150px;">

									<div class="select">
										<select name="selectQuantity" pdt_name="${product['title']}" pdt_id="${product['id']}"
											class="selectQuantity" id="selectQuantity">
											<option selected>Currently ${product['qty']}</option>
											<option>1</option>
											<option>2</option>
											<option>3</option>
											<option>4</option>
										</select>
									</div>

								</td>

								<td class="column-5">Rs ${product['totalprice']}</td>
								<td class="column-5"><button type="button" prod-id="${product['id']}" id="product-delete-btn" class="btn btn-sm btn-danger product-delete-btn">Delete</button></td>
							</tr>
                    `
					});
					tableCart.innerHTML = outputhtml

					//update header cart
					const headerCart = document.getElementById('header-cart')
					let output = ''
					elements.forEach((elem) => {
						console.log('elem', ':', elem)
						outputhtml += `
                        <li id="cart-${elem['prod-id']}" class="header-cart-item flex-w flex-t m-b-12">
                            <div class="header-cart-item-img">
                                <img src="${elem['thumbnail']}" alt="IMG">
                            </div>

                            <div class="header-cart-item-txt p-t-8">
                                <a href="#" class="header-cart-item-name m-b-18 hov-cl1 trans-04">
                                ${elem['title']}
                                </a>

                                <span class="header-cart-item-info">
                                ${elem['qty']} x ${elem['price']}
                                </span>
                            </div>
                        </li>
                    `
					});
					headerCart.innerHTML = output


				}
			});
			// End
		});

		// Add wishlist
		$(document).on('click', ".add-wishlist", function () {
			var _pid = $(this).attr('data-product');
			var _vm = $(this);
			// Ajax
			$.ajax({
				url: "/add-wishlist",
				data: {
					product: _pid
				},
				dataType: 'json',
				success: function (res) {
					if (res.bool == true) {
						_vm.addClass('disabled').removeClass('add-wishlist');
					}
				}
			});
			// EndAjax
		});
		// End

		// Activate selected address
		$(document).on('click', '.activate-address', function () {
			var _aId = $(this).attr('data-address');
			var _vm = $(this);
			// Ajax
			$.ajax({
				url: '/activate-address',
				data: {
					'id': _aId,
				},
				dataType: 'json',
				success: function (res) {
					if (res.bool == true) {
						$(".address").removeClass('shadow border-secondary');
						$(".address" + _aId).addClass('shadow border-secondary');

						$(".check").hide();
						$(".actbtn").show();

						$(".check" + _aId).show();
						$(".btn" + _aId).hide();
					}
				}
			});
			// End
		});

	});
	// End Document.Ready

	// Product Review Save
	$("#addForm").submit(function (e) {
		$.ajax({
			data: $(this).serialize(),
			method: $(this).attr('method'),
			url: $(this).attr('action'),
			dataType: 'json',
			success: function (res) {
				if (res.bool == true) {
					$(".ajaxRes").html('Data has been added.');
					$("#reset").trigger('click');
					// Hide Button
					$(".reviewBtn").hide();
					// End

					// create data for review
					var _html = '<blockquote class="blockquote text-right">';
					_html += '<small>' + res.data.review_text + '</small>';
					_html += '<footer class="blockquote-footer">' + res.data.user;
					_html += '<cite title="Source Title">';
					for (var i = 1; i <= res.data.review_rating; i++) {
						_html += '<i class="fa fa-star text-warning"></i>';
					}
					_html += '</cite>';
					_html += '</footer>';
					_html += '</blockquote>';
					_html += '</hr>';

					$(".no-data").hide();

					// Prepend Data
					$(".review-list").prepend(_html);

					// Hide Modal
					$("#productReview").modal('hide');

					// AVg Rating
					$(".avg-rating").text(res.avg_reviews.avg_rating.toFixed(1))
				}
			}
		});
		e.preventDefault();
	});
</script>